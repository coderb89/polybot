name: PolyBot Trading

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch: {}      # Manual trigger from Actions tab

concurrency:
  group: polybot-trading
  cancel-in-progress: false

permissions:
  contents: write
  pages: write

jobs:
  trade:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore database from artifact
        uses: actions/download-artifact@v4
        with:
          name: polybot-db
          path: data/
        continue-on-error: true  # First run won't have an artifact

      - name: Run PolyBot (single cycle)
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          DRY_RUN: ${{ secrets.DRY_RUN || 'true' }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          NOAA_API_TOKEN: ${{ secrets.NOAA_API_TOKEN }}
          KALSHI_API_KEY: ${{ secrets.KALSHI_API_KEY }}
          KALSHI_API_SECRET: ${{ secrets.KALSHI_API_SECRET }}
          INITIAL_CAPITAL: ${{ secrets.INITIAL_CAPITAL || '100' }}
          GITHUB_ACTIONS: 'true'
        run: python main.py --export-dashboard

      - name: Save database artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: polybot-db
          path: data/polybot.db
          retention-days: 90
          overwrite: true

      - name: Deploy dashboard to GitHub Pages
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create orphan gh-pages branch with dashboard files
          git checkout --orphan gh-pages-deploy

          # Keep only dashboard files
          git rm -rf . 2>/dev/null || true
          mkdir -p dashboard
          git checkout HEAD -- dashboard/index.html 2>/dev/null || true

          # Copy the exported dashboard data
          if [ -f dashboard/dashboard_data.json ]; then
            git add dashboard/dashboard_data.json
          fi
          git add dashboard/index.html 2>/dev/null || true

          # Move files to root for GitHub Pages
          cp dashboard/index.html index.html 2>/dev/null || true
          cp dashboard/dashboard_data.json dashboard_data.json 2>/dev/null || true
          git add index.html dashboard_data.json 2>/dev/null || true

          git commit -m "Update dashboard data" --allow-empty

          git push origin HEAD:gh-pages --force
